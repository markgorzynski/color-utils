# Refactoring Plan V.1

This plan outlines the entire refactoring process for the color libraries, starting with the planning phase, detailing inputs and outputs for every task.

**Phase 0: Planning**

- **Task 1: Create Refactoring Plan**
    - **Performer:** AI
    - **Description:** Analyze the user's request and provided files to develop a detailed, step-by-step plan for refactoring and organizing the color libraries. The plan will specify each task, its performer (Person or AI), required inputs (dependencies), and tangible outputs.
    - **Inputs:**
        - Prompt instructions (The user's request for refactoring and a plan).
        - Original Files: `adaptive-oklab.js`, `aoklab-dark.js`, `aoklab-gray.js`, `aoklab-white.js`, `cat16.js`, `checkWCAGContrast.v4.js`, `chroma-control.js`, `cielab.v3.js`, `color-metrics.js`, `oklab-simple.v3.js`. (These are the subject matter for the plan).
    - **Outputs:**
        - Refactoring Plan Document (text) - This document itself.
    - **Instruction for AI:** Read the prompt and analyze the provided files. Synthesize a structured plan for refactoring the code into modular, consistent, and well-documented libraries. For each step, identify the performer, necessary input files (original or generated by previous tasks), and the tangible output file(s). Format the output as a clear, numbered list following this input/output structure.

**Phase 1: Setup and Architecture Definition**

- **Task 2: Set up Project Workspace**
    
    - **Performer:** Person
    - **Description:** Create the base directory structure for the project.
    - **Inputs:**
        - Refactoring Plan Document (text) - Provides the instruction for this task.
    - **Outputs:**
        - Project Directory (`color-utils/`)
        - Source Directory (`color-utils/src/`)
    - **Instruction for Person:** Read Task 2 in the Refactoring Plan. Create a folder named `color-utils`. Inside it, create a folder named `src`.
- **Task 3: Define Coding Conventions and Architecture**
    
    - **Performer:** Person
    - **Description:** Decide on the project's coding standards (naming, color object structure, units/ranges) and the overall modular architecture, and document these decisions.
    - **Inputs:**
        - Refactoring Plan Document (text) - Provides the instruction for this task.
        - Project Directory (`color-utils/`) - Target location for the output.
        - Original Files: `adaptive-oklab.js`, `aoklab-dark.js`, `aoklab-gray.js`, `aoklab-white.js`, `cat16.js`, `checkWCAGContrast.v4.js`, `chroma-control.js`, `cielab.v3.js`, `color-metrics.js`, `oklab-simple.v3.js`. (Used for context on existing patterns).
    - **Outputs:**
        - Architecture Document (`color-utils/ARCHITECTURE.md`) - A Markdown file detailing the chosen conventions, color object structures, units, ranges, and the planned modular breakdown.
    - **Instruction for Person:** Read Task 3 in the Refactoring Plan. Review the original code for context. Decide on the conventions for naming, color object structures, units, and ranges, and confirm the modular structure proposed in the plan. Create an `ARCHITECTURE.md` file in the `color-utils/` directory and write down these decisions clearly.

**Phase 2: Core Utilities Module**

- **Task 4: Generate Core Utilities Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the core utility functions, following the defined conventions.
    - **Inputs:**
        - Refactoring Plan Document (text) - Provides the instruction for this task.
        - Architecture Document (`color-utils/ARCHITECTURE.md`) - Defines conventions, color object structures, and units/ranges.
        - Original Files: `adaptive-oklab.js`, `aoklab-dark.js`, `aoklab-gray.js`, `aoklab-white.js`, `cielab.v3.js`, `oklab-simple.v3.js`, `color-metrics.js`, `cat16.js`, `checkWCAGContrast.v4.js`. (Source code for utilities).
    - **Outputs:**
        - Utils Code Content (string).
    - **Instruction for AI:** Read Task 4 in the Refactoring Plan, the `ARCHITECTURE.md`, and the specified original files. Consolidate the required helper functions, apply the conventions, and generate the complete string content for `utils.js`.
- **Task 5: Create Core Utilities File**
    
    - **Performer:** Person
    - **Description:** Create the `utils.js` file in the source directory and populate it with the generated code content.
    - **Inputs:**
        - Refactoring Plan Document (text) - Provides the instruction for this task.
        - Source Directory (`color-utils/src/`) - Target location.
        - Utils Code Content (string) - Generated by Task 4.
    - **Outputs:**
        - Core Utilities File (`color-utils/src/utils.js`)
    - **Instruction for Person:** Read Task 5 in the Refactoring Plan. In the `src` folder, create a new file named `utils.js`. Copy the code content provided by the AI for `utils.js` and paste it in. Save the file.

**Phase 3: Color Space Modules**

- **Task 6: Generate sRGB Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the sRGB <-> XYZ conversion module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`) - Provides utility functions (implicit dependency for future tasks, explicit if used in `srgb.js`).
        - Original Files: `cielab.v3.js`, `cat16.js`.
    - **Outputs:**
        - sRGB Module Code Content (string).
    - **Instruction for AI:** Read Task 6, the `ARCHITECTURE.md`, and the original files. Extract sRGB <-> XYZ logic, apply conventions, and generate the content for `srgb.js`.
- **Task 7: Create sRGB Module File**
    
    - **Performer:** Person
    - **Description:** Create the `srgb.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - sRGB Module Code Content (string) - Generated by Task 6.
    - **Outputs:**
        - sRGB Module File (`color-utils/src/srgb.js`)
    - **Instruction for Person:** Read Task 7. In `src`, create `srgb.js`. Copy the AI's content and save.
- **Task 8: Generate CIELAB Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the CIELAB <-> XYZ conversion module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Original Files: `cielab.v3.js`.
    - **Outputs:**
        - CIELAB Module Code Content (string).
    - **Instruction for AI:** Read Task 8, the `ARCHITECTURE.md`, and `cielab.v3.js`. Extract Lab <-> XYZ logic, apply conventions, and generate the content for `cielab.js`.
- **Task 9: Create CIELAB Module File**
    
    - **Performer:** Person
    - **Description:** Create the `cielab.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - CIELAB Module Code Content (string) - Generated by Task 8.
    - **Outputs:**
        - CIELAB Module File (`color-utils/src/cielab.js`)
    - **Instruction for Person:** Read Task 9. In `src`, create `cielab.js`. Copy the AI's content and save.
- **Task 10: Generate CIELCh Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the CIELAB <-> CIELCh conversion module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`) - Provides angle conversion helpers.
        - CIELAB Module File (`color-utils/src/cielab.js`) - Implicit dependency for context on Lab format.
        - Original Files: `cielab.v3.js` (for context on LCh mention).
    - **Outputs:**
        - CIELCh Module Code Content (string).
    - **Instruction for AI:** Read Task 10, the `ARCHITECTURE.md`, and `utils.js`. Implement Lab <-> LCh formulas, apply conventions, and generate content for `cielch.js`.
- **Task 11: Create CIELCh Module File**
    
    - **Performer:** Person
    - **Description:** Create the `cielch.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - CIELCh Module Code Content (string) - Generated by Task 10.
    - **Outputs:**
        - CIELCh Module File (`color-utils/src/cielch.js`)
    - **Instruction for Person:** Read Task 11. In `src`, create `cielch.js`. Copy the AI's content and save.
- **Task 12: Generate OKLab Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the linear sRGB <-> standard OKLab conversion module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - sRGB Module File (`color-utils/src/srgb.js`) - Implicit dependency for sRGB context.
        - Original Files: `oklab-simple.v3.js`.
    - **Outputs:**
        - OKLab Module Code Content (string).
    - **Instruction for AI:** Read Task 12, the `ARCHITECTURE.md`, and `oklab-simple.v3.js`. Extract OKLab conversion logic and matrices, apply conventions, and generate content for `oklab.js`.
- **Task 13: Create OKLab Module File**
    
    - **Performer:** Person
    - **Description:** Create the `oklab.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - OKLab Module Code Content (string) - Generated by Task 12.
    - **Outputs:**
        - OKLab Module File (`color-utils/src/oklab.js`)
    - **Instruction for Person:** Read Task 13. In `src`, create `oklab.js`. Copy the AI's content and save.
- **Task 14: Generate OKLCh Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the OKLab <-> OKLCh conversion module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`) - Provides angle conversion helpers.
        - OKLab Module File (`color-utils/src/oklab.js`) - Implicit dependency for OKLab format.
        - Original Files: `chroma-control.js` (for context on OKLCh usage).
    - **Outputs:**
        - OKLCh Module Code Content (string).
    - **Instruction for AI:** Read Task 14, the `ARCHITECTURE.md`, and `utils.js`. Implement OKLab <-> OKLCh formulas, apply conventions, and generate content for `oklch.js`.
- **Task 15: Create OKLCh Module File**
    
    - **Performer:** Person
    - **Description:** Create the `oklch.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - OKLCh Module Code Content (string) - Generated by Task 14.
    - **Outputs:**
        - OKLCh Module File (`color-utils/src/oklch.js`)
    - **Instruction for Person:** Read Task 15. In `src`, create `oklch.js`. Copy the AI's content and save.
- **Task 16: Generate Adaptive OKLab Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the Adaptive OKLab module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`).
        - sRGB Module File (`color-utils/src/srgb.js`) - For linear sRGB <-> XYZ conversions.
        - Original Files: `adaptive-oklab.js`, `aoklab-dark.js`, `aoklab-gray.js`, `aoklab-white.js`.
    - **Outputs:**
        - Adaptive OKLab Module Code Content (string).
    - **Instruction for AI:** Read Task 16, `ARCHITECTURE.md`, `utils.js`, `srgb.js`, and the original files. Extract adaptive OKLab logic, apply conventions, and generate content for `aoklab.js`.
- **Task 17: Create Adaptive OKLab Module File**
    
    - **Performer:** Person
    - **Description:** Create the `aoklab.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - Adaptive OKLab Module Code Content (string) - Generated by Task 16.
    - **Outputs:**
        - Adaptive OKLab Module File (`color-utils/src/aoklab.js`)
    - **Instruction for Person:** Read Task 17. In `src`, create `aoklab.js`. Copy the AI's content and save.
- **Task 18: Generate CIECAM16 Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the CIECAM16 computation module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`).
        - sRGB Module File (`color-utils/src/srgb.js`).
        - Original Files: `cat16.js`.
    - **Outputs:**
        - CIECAM16 Module Code Content (string).
    - **Instruction for AI:** Read Task 18, `ARCHITECTURE.md`, `utils.js`, `srgb.js`, and `cat16.js`. Extract CIECAM16 logic, apply conventions, and generate content for `ciecam16.js`.
- **Task 19: Create CIECAM16 Module File**
    
    - **Performer:** Person
    - **Description:** Create the `ciecam16.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - CIECAM16 Module Code Content (string) - Generated by Task 18.
    - **Outputs:**
        - CIECAM16 Module File (`color-utils/src/ciecam16.js`)
    - **Instruction for Person:** Read Task 19. In `src`, create `ciecam16.js`. Copy the AI's content and save.

**Phase 4: Color Metrics and Chroma Control**

- **Task 20: Generate Color Metrics Module Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the color metrics module, following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Core Utilities File (`color-utils/src/utils.js`).
        - Original Files: `color-metrics.js`, `checkWCAGContrast.v4.js`.
    - **Outputs:**
        - Color Metrics Module Code Content (string).
    - **Instruction for AI:** Read Task 20, `ARCHITECTURE.md`, `utils.js`, `color-metrics.js`, and `checkWCAGContrast.v4.js`. Extract metrics logic, apply conventions, incorporate WCAG hex/caching as analyzed, and generate content for `color-metrics.js`.
- **Task 21: Create Color Metrics Module File**
    
    - **Performer:** Person
    - **Description:** Create the `color-metrics.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - Color Metrics Module Code Content (string) - Generated by Task 20.
    - **Outputs:**
        - Color Metrics Module File (`color-utils/src/color-metrics.js`)
    - **Instruction for Person:** Read Task 21. In `src`, create `color-metrics.js`. Copy the AI's content and save.
- **Task 22: Generate Chroma Control Module Code Content (Initial)**
    
    - **Performer:** AI
    - **Description:** Generate the initial code content string for the chroma control module, following conventions, including placeholders for the missing dependency.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - OKLCh Module File (`color-utils/src/oklch.js`).
        - CIELAB Module File (`color-utils/src/cielab.js`).
        - Original Files: `chroma-control.js`.
    - **Outputs:**
        - Chroma Control Module Code Content (string - initial version).
    - **Instruction for AI:** Read Task 22, `ARCHITECTURE.md`, `oklch.js`, `cielab.js`, and `chroma-control.js`. Extract the structure and logic, apply conventions, add dependency placeholders, and generate content for `chroma-control.js`.
- **Task 23: Create Chroma Control Module File (Initial)**
    
    - **Performer:** Person
    - **Description:** Create the `chroma-control.js` file and populate it with the initial generated code.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - Chroma Control Module Code Content (string - initial) - Generated by Task 22.
    - **Outputs:**
        - Chroma Control Module File (`color-utils/src/chroma-control.js` - initial version).
    - **Instruction for Person:** Read Task 23. In `src`, create `chroma-control.js`. Copy the AI's content and save.
- **Task 24: Implement Chroma Control Dependency and Finalize Module Code**
    
    - **Performer:** Person
    - **Description:** Implement the missing functionality in the chroma control module, resolving the dependency on `matchoklch.v3.js`.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Chroma Control Module File (`color-utils/src/chroma-control.js` - initial).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Other Source Files (`color-utils/src/*.js`) - For reimplementing functionality (e.g., `oklch.js`, `cielab.js`, `srgb.js`, `utils.js`).
        - (Optional) Original `matchoklch.v3.js` file content - If available.
    - **Outputs:**
        - Chroma Control Module File (`color-utils/src/chroma-control.js` - finalized).
    - **Instruction for Person:** Read Task 24. Open `src/chroma-control.js`. Address the missing `matchoklch.v3.js` dependency by implementing the necessary logic using the refactored modules or integrating the original code. Ensure your additions follow the conventions and integrate correctly. Save the file.

**Phase 5: Project Files and Documentation**

- **Task 25: Create Package File**
    
    - **Performer:** Person
    - **Description:** Create the `package.json` file for the project.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Project Directory (`color-utils/`).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Source Directory (`color-utils/src/`).
    - **Outputs:**
        - Package File (`color-utils/package.json`)
    - **Instruction for Person:** Read Task 25. In the root directory, create `package.json`. Fill in standard details, setting `main` to `src/index.js`. Save.
- **Task 26: Generate Main Entry Point Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the main entry point file (`index.js`), following conventions.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - All Source Files (`color-utils/src/*.js`) - To identify functions/classes to re-export.
    - **Outputs:**
        - Main Entry Point Code Content (string).
    - **Instruction for AI:** Read Task 26, `ARCHITECTURE.md`, and the contents of the `src` directory. Select core public functions/classes and generate the content for `index.js`, including imports, re-exports, and JSDoc, following conventions.
- **Task 27: Create Main Entry Point File**
    
    - **Performer:** Person
    - **Description:** Create the `index.js` file and populate it.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - Main Entry Point Code Content (string) - Generated by Task 26.
    - **Outputs:**
        - Main Entry Point File (`color-utils/src/index.js`)
    - **Instruction for Person:** Read Task 27. In `src`, create `index.js`. Copy the AI's content and save.
- **Task 28: Generate Type Definitions Code Content**
    
    - **Performer:** AI
    - **Description:** Generate the code content string for the JSDoc type definitions file (`types.js`), based on the defined color object structures.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Architecture Document (`color-utils/ARCHITECTURE.md`) - Defines color object structures.
    - **Outputs:**
        - Type Definitions Code Content (string).
    - **Instruction for AI:** Read Task 28 and `ARCHITECTURE.md`. Create `@typedef` definitions for the specified color object structures and generate the content for `types.js`.
- **Task 29: Create Type Definitions File and Update JSDoc**
    
    - **Performer:** Person
    - **Description:** Create the `types.js` file, populate it, and update JSDoc comments in other source files to use these typedefs.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Source Directory (`color-utils/src/`).
        - Type Definitions Code Content (string) - Generated by Task 28.
        - All other Source Files (`color-utils/src/*.js`) - To update JSDoc.
    - **Outputs:**
        - Type Definitions File (`color-utils/src/types.js`)
        - Modified Source Files (`color-utils/src/*.js`) - With updated JSDoc.
    - **Instruction for Person:** Read Task 29. In `src`, create `types.js`. Copy the AI's content and save. Then, manually or using a find/replace tool, update the `@param` and `@returns` JSDoc tags in all other `*.js` files in `src` to use the new typedefs (e.g., `@param {RgbColor} color`). Save the modified files.

**Phase 6: Documentation and Testing**

- **Task 30: Write Comprehensive README**
    
    - **Performer:** Person
    - **Description:** Write the main documentation file for the project.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Project Directory (`color-utils/`).
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
        - Package File (`color-utils/package.json`).
        - Main Entry Point File (`color-utils/src/index.js`).
        - Chroma Control Module File (`color-utils/src/chroma-control.js` - finalized).
        - All other Source Files (`color-utils/src/*.js`) - To list supported features.
    - **Outputs:**
        - README File (`color-utils/README.md`)
    - **Instruction for Person:** Read Task 30. In the root directory, create or update `README.md`. Write the documentation content as described, referencing the input files for details and adhering to conventions. Save.
- **Task 31: Plan and Generate Reference Manual**
    
    - **Performer:** Person
    - **Description:** Set up and run a documentation generation tool to create an API reference based on JSDoc comments.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Project Directory (`color-utils/`).
        - Source Directory (`color-utils/src/`) - Contains all code with JSDoc.
        - Type Definitions File (`color-utils/src/types.js`).
    - **Outputs:**
        - Documentation Directory (`color-utils/docs/` or similar) - Containing the generated API reference files.
    - **Instruction for Person:** Read Task 31. Choose and set up a JSDoc-compatible tool. Configure it to process your source files and typedefs. Run the tool. Create a `docs` folder (or location of choice) and place the generated files there.
- **Task 32: Testing and Validation**
    
    - **Performer:** Person
    - **Description:** Write and run unit tests to verify the correctness of the refactored code.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - Project Directory (`color-utils/`).
        - All Source Files (`color-utils/src/*.js`) - The code to be tested.
        - Package File (`color-utils/package.json`) - To add testing dependencies/scripts.
        - Architecture Document (`color-utils/ARCHITECTURE.md`) - Context on expected behavior.
    - **Outputs:**
        - Test Directory and Files (`color-utils/test/` or similar) - Containing test code.
        - (Implicit) Debugged Source Files (`color-utils/src/*.js`) - As bugs are found and fixed.
    - **Instruction for Person:** Read Task 32. Set up a testing environment. Create a `test` folder. Write unit tests covering all major functionalities. Run the tests (`npm test`). Debug and fix code in `src` until tests pass.
- **Task 33: Review Code Consistency and Style**
    
    - **Performer:** AI
    - **Description:** Review the final code files for consistency and adherence to conventions after the Person's modifications and testing.
    - **Inputs:**
        - Refactoring Plan Document (text).
        - All Source Files (`color-utils/src/*.js`) - The final code state.
        - Architecture Document (`color-utils/ARCHITECTURE.md`).
    - **Outputs:**
        - Consistency Review Feedback (text) - Suggestions for further refinement.
    - **Instruction for AI:** Read Task 33, the `ARCHITECTURE.md`, and the final source files. Analyze the code for adherence to conventions, quality of JSDoc/typedef usage, and overall consistency. Provide detailed feedback to the Person.

This comprehensive task list, starting with the plan itself and explicitly outlining inputs and outputs for every step, provides a clear roadmap and dependency chain for the refactoring project.